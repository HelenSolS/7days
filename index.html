
import React, { useState, useEffect, useMemo } from 'react';
import { MARATHON_DAYS } from './constants';
import { UserProgress } from './types';
import { 
  CheckCircle2, Sparkles, Video, Zap, Target, Loader2,
  Moon, Sun, Coffee, MessageCircle, ArrowRight, ChevronLeft, Info
} from 'lucide-react';

const WEBHOOK_URL = 'https://helensols.hooks.n8n.cloud/marathon-report'; 

const App: React.FC = () => {
  const [currentDayId, setCurrentDayId] = useState<number>(1);
  const [currentPart, setCurrentPart] = useState<number>(0); 
  const [loading, setLoading] = useState(false);
  const [answerText, setAnswerText] = useState("");
  const [selectedOption, setSelectedOption] = useState<string | null>(null);

  const [progress, setProgress] = useState<UserProgress>(() => {
    const saved = localStorage.getItem('marathon_state_v6');
    return saved ? JSON.parse(saved) : { completedDays: [], currentDay: 1, lastVisit: new Date().toISOString(), answers: {} };
  });

  const tg = window.Telegram?.WebApp;

  useEffect(() => {
    if (tg) {
      tg.ready();
      tg.expand();
      if (tg.setHeaderColor) tg.setHeaderColor('secondary_bg_color');
    }

    // Определяем день: либо из URL (?day=X), либо первый незавершенный
    const params = new URLSearchParams(window.location.search);
    const dayParam = params.get('day');
    
    if (dayParam) {
      const dId = parseInt(dayParam, 10);
      if (!isNaN(dId) && dId >= 1 && dId <= 7) {
        setCurrentDayId(dId);
      }
    } else {
      const firstUnfinished = MARATHON_DAYS.find(d => !progress.completedDays.includes(d.id));
      if (firstUnfinished) setCurrentDayId(firstUnfinished.id);
    }
  }, []);

  const currentDay = useMemo(() => 
    MARATHON_DAYS.find(d => d.id === currentDayId) || MARATHON_DAYS[0]
  , [currentDayId]);

  const isDayFinished = progress.completedDays.includes(currentDayId);

  const handleNextPart = () => {
    if (currentPart < 2) {
      setCurrentPart(currentPart + 1);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      tg?.HapticFeedback?.selectionChanged();
    }
  };

  const handlePrevPart = () => {
    if (currentPart > 0) setCurrentPart(currentPart - 1);
  };

  const handleCompleteDay = async () => {
    if (currentPart === 2 && !selectedOption && currentDay.interactive.type !== 'breath') {
      tg?.showAlert?.("Пожалуйста, выберите вариант ответа.");
      return;
    }

    setLoading(true);
    const user = tg?.initDataUnsafe?.user;
    
    const payload = {
      user_id: user?.id,
      fio: user ? `${user.first_name} ${user.last_name || ''}`.trim() : 'Аноним',
      username: user?.username || 'unknown',
      day: currentDayId,
      topic: currentDay.topic,
      choice: selectedOption,
      note: answerText,
      timestamp: new Date().toISOString()
    };

    try {
      // Пытаемся отправить на вебхук
      await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const newProgress = {
        ...progress,
        completedDays: [...new Set([...progress.completedDays, currentDayId])],
        answers: { ...progress.answers, [currentDayId]: { note: answerText, choice: selectedOption } }
      };
      
      setProgress(newProgress);
      localStorage.setItem('marathon_state_v6', JSON.stringify(newProgress));
      tg?.HapticFeedback?.notificationOccurred('success');
    } catch (e) {
      console.error('Webhook failed, saving locally:', e);
      const newProgress = {
        ...progress,
        completedDays: [...new Set([...progress.completedDays, currentDayId])]
      };
      setProgress(newProgress);
      localStorage.setItem('marathon_state_v6', JSON.stringify(newProgress));
    } finally {
      setLoading(false);
    }
  };

  if (isDayFinished) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-[#FAF6F1] animate-fade-in">
        <div className="w-24 h-24 bg-white rounded-[2.5rem] shadow-xl flex items-center justify-center mb-10 border border-gray-100">
          <Sparkles className="text-[#8FBC8F] w-12 h-12" />
        </div>
        <h2 className="text-3xl font-bold mb-4 font-lora">День пройден!</h2>
        <p className="text-gray-500 mb-12 text-sm leading-relaxed max-w-[280px]">
          Твое тело услышано. <br/>Инсайты сохранены. Завтра в 09:15 бот пришлет новую миссию.
        </p>
        <button 
          onClick={() => tg?.close()} 
          className="px-12 py-5 bg-white border border-gray-200 rounded-full text-[11px] font-black uppercase tracking-[0.2em] text-gray-400 active:scale-95 transition-all shadow-sm"
        >
          Закрыть дневник
        </button>
      </div>
    );
  }

  return (
    <div className="max-w-md mx-auto min-h-screen bg-[#FAF6F1] pb-20">
      {/* HEADER WITH IMAGE */}
      <div className="relative aspect-[4/3] overflow-hidden rounded-b-[4rem] shadow-2xl">
        <img src={currentDay.image} className="w-full h-full object-cover transition-transform duration-[3s] hover:scale-110" alt="" />
        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent" />
        
        <div className="absolute top-12 left-6 right-6 flex justify-between items-center">
          {currentPart > 0 ? (
            <button onClick={handlePrevPart} className="p-3 glass rounded-2xl text-white active:scale-90 transition-all">
              <ChevronLeft size={20}/>
            </button>
          ) : <div className="w-10"/>}
          <div className="bg-white/95 px-6 py-2.5 rounded-full shadow-lg flex items-center gap-3 border border-white/50">
             {currentPart === 0 ? <Sun size={18} className="text-orange-400"/> : currentPart === 1 ? <Coffee size={18} className="text-amber-800"/> : <Moon size={18} className="text-indigo-600"/>}
             <span className="text-[11px] font-black uppercase tracking-[0.2em] text-gray-800">
               {currentPart === 0 ? 'Утро' : currentPart === 1 ? 'День' : 'Вечер'}
             </span>
          </div>
          <div className="w-10"/>
        </div>

        <div className="absolute bottom-12 left-10 right-10 text-white animate-fade-in">
          <div className="flex items-center gap-2 opacity-60 mb-3">
            <Target size={14} className="text-[#8FBC8F]" />
            <span className="text-[10px] font-black uppercase tracking-[0.3em]">{currentDay.title}</span>
          </div>
          <h1 className="text-3xl font-bold font-lora leading-tight">{currentDay.topic}</h1>
        </div>
      </div>

      <div className="px-6 mt-10 space-y-10">
        {/* PART 0: THEORY / VIDEO SCENARIO */}
        {currentPart === 0 && (
          <div className="space-y-8 animate-fade-in">
            <div className="bg-white rounded-[3rem] p-10 shadow-sm border border-gray-100/50">
              <div className="flex items-center gap-3 mb-8">
                <div className="p-2 bg-[#F0F7F0] rounded-xl">
                  <Video size={20} className="text-[#8FBC8F]" />
                </div>
                <h3 className="text-[11px] font-black uppercase tracking-[0.2em] text-gray-400">Сценарий дня</h3>
              </div>
              
              <p className="text-xl font-lora italic leading-relaxed text-gray-800 mb-10 border-l-[5px] border-[#E6C2BF] pl-6">
                "{currentDay.videoScenario.hook}"
              </p>

              <div className="space-y-5">
                {currentDay.videoScenario.examples.map((ex, i) => (
                  <div key={i} className="flex gap-5 p-6 bg-[#FAF9F7] rounded-[2rem] border border-gray-50 transition-all hover:bg-white hover:shadow-md group">
                    <span className="text-3xl grayscale group-hover:grayscale-0 transition-all">{ex.icon}</span>
                    <div>
                      <h4 className="font-bold text-sm text-gray-900 mb-1.5">{ex.title}</h4>
                      <p className="text-[13px] text-gray-500 leading-relaxed font-medium">{ex.text}</p>
                    </div>
                  </div>
                ))}
              </div>

              <button 
                onClick={handleNextPart} 
                className="w-full mt-12 py-6 bg-[#8FBC8F] text-white rounded-[2.5rem] font-black text-[12px] uppercase tracking-[0.25em] flex items-center justify-center gap-4 active:scale-95 transition-all shadow-xl shadow-green-100"
              >
                К практике дня <ArrowRight size={20}/>
              </button>
            </div>
          </div>
        )}

        {/* PART 1: PRACTICE */}
        {currentPart === 1 && (
          <div className="space-y-8 animate-fade-in">
            <div className="bg-[#8FBC8F] rounded-[3.5rem] p-10 text-white shadow-2xl shadow-green-100 relative overflow-hidden">
               <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl" />
               <div className="flex items-center gap-4 mb-10 opacity-70">
                 <Zap size={22} className="fill-white"/>
                 <h2 className="text-[11px] font-black uppercase tracking-[0.3em]">Инструкция Агента</h2>
               </div>
               
               <h3 className="text-2xl font-bold mb-10 font-lora leading-tight">{currentDay.practice.title}</h3>
               
               <div className="space-y-10">
                 {currentDay.practice.steps.map((step, i) => (
                   <div key={i} className="flex gap-6">
                     <div className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center text-[13px] font-black shrink-0 border border-white/30 backdrop-blur-md">
                       {i + 1}
                     </div>
                     <div className="pt-1">
                       <h4 className="font-black text-[13px] uppercase tracking-wider mb-2">{step.title}</h4>
                       <p className="text-[15px] opacity-90 leading-relaxed font-medium">{step.text}</p>
                     </div>
                   </div>
                 ))}
               </div>

               <div className="mt-12 p-6 bg-white/10 rounded-[2rem] border border-white/10 flex items-start gap-5">
                 <Info size={24} className="opacity-60 shrink-0 mt-1" />
                 <p className="text-[13px] font-bold italic opacity-90 leading-relaxed">"{currentDay.practice.result}"</p>
               </div>

               <button 
                onClick={handleNextPart} 
                className="w-full mt-14 py-6 bg-white text-[#8FBC8F] rounded-[2.5rem] font-black text-[12px] uppercase tracking-[0.25em] flex items-center justify-center gap-4 active:scale-95 transition-all shadow-xl shadow-black/5"
              >
                К отчету дня <ArrowRight size={20}/>
              </button>
            </div>
          </div>
        )}

        {/* PART 2: INTERACTIVE / REFLECTION */}
        {currentPart === 2 && (
          <div className="space-y-8 animate-fade-in">
            <div className="bg-white rounded-[3.5rem] p-10 shadow-sm border border-gray-100/50">
              <div className="flex items-center gap-3 mb-10">
                <MessageCircle size={18} className="text-[#E6C2BF]" />
                <h3 className="text-[11px] font-black uppercase tracking-[0.3em] text-gray-300">Рефлексия</h3>
              </div>
              
              <h3 className="text-2xl font-bold font-lora mb-12 text-gray-800 leading-tight">
                {currentDay.interactive.question}
              </h3>
              
              <div className="space-y-4 mb-12">
                {currentDay.interactive.options?.map(opt => (
                  <button 
                    key={opt.value}
                    onClick={() => { setSelectedOption(opt.value); tg?.HapticFeedback?.selectionChanged(); }}
                    className={`w-full p-7 rounded-[2.5rem] border-2 transition-all duration-500 flex items-center gap-5 ${
                      selectedOption === opt.value 
                      ? 'border-[#8FBC8F] bg-[#F0F7F0] scale-[1.02] shadow-lg shadow-green-50' 
                      : 'border-gray-50 bg-[#FAF9F7] hover:bg-white hover:border-gray-200'
                    }`}
                  >
                    <span className="text-3xl grayscale-0">{opt.icon}</span>
                    <span className={`text-[13px] font-black uppercase tracking-widest ${selectedOption === opt.value ? 'text-[#3D3D3D]' : 'text-gray-400'}`}>
                      {opt.label}
                    </span>
                  </button>
                ))}

                {currentDay.interactive.type === 'breath' && (
                  <div className="py-14 flex flex-col items-center">
                    <div className="w-40 h-40 rounded-full border-[12px] border-[#8FBC8F]/10 flex items-center justify-center relative">
                      <div className="absolute inset-0 rounded-full border-[4px] border-[#8FBC8F] animate-breathe opacity-20" />
                      <div className="w-28 h-28 bg-[#8FBC8F]/5 rounded-full flex items-center justify-center">
                        <span className="text-[12px] text-[#8FBC8F] font-black uppercase tracking-widest animate-pulse">Дыши</span>
                      </div>
                    </div>
                    <p className="mt-10 text-[12px] text-gray-400 text-center italic font-medium px-8 leading-relaxed">
                      Следуй за пульсацией. Вдох носом, длинный выдох.
                    </p>
                  </div>
                )}
              </div>

              <div className="space-y-4 mb-12">
                <div className="flex items-center gap-3 px-4 opacity-40">
                  <Sparkles size={16} className="text-[#8FBC8F]"/>
                  <span className="text-[10px] font-black uppercase tracking-[0.3em]">Твой инсайт</span>
                </div>
                <textarea 
                  value={answerText}
                  onChange={(e) => setAnswerText(e.target.value)}
                  placeholder="Что сегодня подало голос в твоем теле?.."
                  className="w-full p-8 bg-[#FAF9F7] rounded-[2.5rem] border-none focus:ring-[4px] focus:ring-[#8FBC8F]/10 min-h-[160px] text-[15px] text-gray-700 placeholder:text-gray-300 transition-all font-medium leading-relaxed"
                />
              </div>

              <button 
                onClick={handleCompleteDay} 
                disabled={loading}
                className="w-full py-7 bg-[#8FBC8F] text-white rounded-[2.5rem] font-black text-[13px] uppercase tracking-[0.3em] flex items-center justify-center gap-4 active:scale-95 transition-all shadow-2xl shadow-green-100"
              >
                {loading ? <Loader2 className="animate-spin" /> : <><CheckCircle2 size={22}/> Завершить миссию</>}
              </button>
            </div>
          </div>
        )}
      </div>

      {/* FOOTER PREVIEW */}
      <div className="px-6 mt-16 mb-12">
         <div className="bg-[#2B2D42] rounded-[3rem] p-10 text-white/95 space-y-8 shadow-2xl">
            <div className="flex items-center gap-4 opacity-40">
              <Info size={16} className="text-[#8FBC8F]"/>
              <h4 className="text-[10px] font-black uppercase tracking-[0.4em]">Завтра в 09:15</h4>
            </div>
            <p className="font-lora italic text-xl text-indigo-100 border-l-[3px] border-[#8FBC8F]/40 pl-8 py-2 leading-relaxed">
              "{currentDay.botTimeline.morning.text}"
            </p>
            <div className="flex justify-between items-center opacity-30 pt-4 border-t border-white/5">
               <span className="text-[10px] font-black uppercase tracking-widest">Day {currentDayId} / 7</span>
               <Sparkles size={16} />
            </div>
         </div>
      </div>
    </div>
  );
};

export default App;
